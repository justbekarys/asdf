<!DOCTYPE html>
<meta charset="utf-8">
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<style>
html,
body {
    width: 100%;
    height: 100%;
    margin: 0;
    padding: 0;
}

.tooltip {
    position: absolute;
    line-height: .7;
    font-weight: bold;
    padding: 8px;
    background: rgba(0, 0, 0, 0.8);
    color: #fff;
    font-weight: bold;
    font: 11.5px sans-serif;
    border-radius: 2px;
    pointer-events: none;
}

#map {
    width: 50%;
    height: 100%;
    padding: 0;
    margin-left: 15%;
}

#div1 {
    width: 50%;
    float: left;
}

.stations,
.stations svg {
    position: absolute;
}

.stations svg {
    width: 60px;
    height: 20px;
    padding-right: 100px;
    font: 10px sans-serif;
}

.stations circle {
    fill: brown;
    stroke: black;
    stroke-width: 1.5px;
}
</style>
<div id="div1"></div>
<div id="map"></div>

<head></head>

<body></body>
<script src="//maps.google.com/maps/api/js?sensor=true"></script>
<script src="//d3js.org/d3.v3.min.js"></script>
<script>
// Create the Google Mapâ€¦
var map = new google.maps.Map(d3.select("#map").node(), {
    zoom: 10,
    draggableCursor: 'crosshair',
    center: new google.maps.LatLng(-35.0004451, 138.3309748),
    mapTypeId: google.maps.MapTypeId.TERRAIN,
    backgroundColor: "white",
    mapMaker: 'True',
    styles: [{
        featureType: "all",
        elementType: "labels",
        stylers: [{ visibility: "off" }]
    }]
});


var stopRoutes = {};
d3.csv("stopRoutes.csv", function(error, data) {
    if (error) throw error;
    data.forEach(element => stopRoutes[element.StopName] = element.RouteID);
});

d3.csv("Routes.csv", function(error, data) {
    if (error) throw error;
    data.forEach(element => stopRoutes[element.StopName] = element.RouteID);

    d3.select("#div1")
        .selectAll("input")
        .data(data)
        .enter()
        .append("input")
        .attr("type", "button")
        .attr("class", "button")
        .attr("value", function(d) { return d.routes; })
        .on("mouseover", function(d) {
            d3.selectAll(".i"+d.routes).style("fill", "yellow");
        })
        .on("mouseout", function(d) {
            d3.selectAll(".i"+d.routes).style("fill", "brown");
        });
});

d3.csv("locations.csv", function(error, data) {
    if (error) throw error;
    var overlay = new google.maps.OverlayView();

    overlay.onAdd = function() {
        var layer = d3.select(this.getPanes().overlayMouseTarget).append("div")
            .attr("class", "stations");

        overlay.draw = function() {
            var projection = this.getProjection(),
                padding = 10;

            var marker = layer.selectAll("svg")
                .data(d3.entries(data))
                .each(transform)
                .enter().append("svg")
                .each(transform)
                .attr("class", "marker");

            var tooltip = d3.select("body")
                .append("div")
                .attr("class", "tooltip")
                .style("opacity", 0);

            // Add a circle.
            marker.append("circle")
                .attr("r", 4.5)
                .attr("cx", padding)
                .attr("cy", padding)
                .attr("class", function(d) {
                    let classes = stopRoutes[d.value['Stops']].slice(1, -1);
                    return "i" + classes.replaceAll("'", "").replaceAll(', ', ' i');
                })
                .on("mouseover", function(d) {
                    d3.select(this).attr({
                        r: 9
                    }).style("fill", "yellow");
                    tooltip.transition()
                        .duration(200)
                        .style("opacity", .9);
                    tooltip.html('BusStation: ' + d.value['Stops'] + '<br>' + 'Buses: ' + stopRoutes[d.value['Stops']].toString())
                        .style("left", (d3.event.pageX + 5) + "px")
                        .style("top", (d3.event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).attr({
                        r: 4.5
                    }).style("fill", "brown");;
                });

            // Add a label.
            marker.append("text")
                .attr("x", padding + 7)
                .attr("y", padding)
                .attr("dy", ".31em")
                .text(function(d) { return d.value['Stops']; });

            function transform(d) {
                d = new google.maps.LatLng(d.value['Lat'], d.value['Lng']);
                d = projection.fromLatLngToDivPixel(d);
                return d3.select(this)
                    .style("left", (d.x - padding) + "px")
                    .style("top", (d.y - padding) + "px");
            }
        };
    };

    overlay.setMap(map);
});

function handleMouseOver(d, i) {

    d3.select(this).attr({
        fill: "orange",
        r: radius * 2
    });
}
</script>